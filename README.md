# Simple message broker

This was a graded university project. The commit history has been altered for publication on GitHub.

## Requirements

### General

* 3 programs for simple message broker architecture
  * communication between these is done using UDP
  * they are all non-interactive CLI programs
  * must fulfil their intended functions and be well documented
  * can be compiled using a standard C compiler (such as gcc)
* also an explanatory text that covers
  * how the programs function
  * the designed message broker protocol
  * the implementation of the 3 programs

### Publisher

* a request sent by the publisher consists auf a `topic` and a `message`
* `topic` and `message` are basic strings
* the publisher is called with the appropriate CLI arguments, sends a publish request to the broker and then terminates
* call pattern: `smbpuslish broker topic message`
  * `broker` = host name / IP-address of the broker
  * `topic` = the topic to publish to
  * `message` = the message to be published
* the publisher is not allowed to use the `#` wildcard for the topic

### Subscriber

* the subscriber is called with `topic` as a CLI argument, subscribes that topic at the specified broker and then listens for messages from the broker in an infinite loop, which it will then print to stdout
* call pattern: `smbsubscribe broker topic`
  * `broker` = host name / IP-address of the broker
  * `topic` = topic to subscribe to
* may use the `#` wildcard for `topic` to receive messages for all topics
  * make sure to place `#` in quotes when using it as a CLI argument, as it will otherwise be interpreted as a shell comment

### Broker

* allows subscribers to subscribe a topic, thus memorizing them for later message forwarding
* upon reception of a publish request by a publisher, immediately forwards the contained message to all subscribers that are currently subscribed to the respective topic
  * there is no need to retain received messages, they can be discarded as soon as they have been forwarded to the subscribers
* subscribers that subscribe to the `#` topic will receive messages from all topics

### Extra features

One may improve their grade for this project by adding further features on top
of the basic requirements that are defined above.

## My implementation

### smbsubscribe

smbsubscribe is called with the pattern `smbsubscribe broker topic`, where `broker` is the host name or IP-address of the broker and `topic` is the topic that is to be subscribed at the broker.
The destination port on the broker that requests will be sent to is 8080, based on a constant in [smbconstants.h](smbconstants.h).
The subscriber will send a request to the broker to subscribe to the specified topic.
Afterwards the subscriber will enter an infinite loop in which it will await messages from the broker.
Once a message is received from the broker, it is printed to stdout.
If `#` was chosen as a topic, the subscriber will receive messages for all topics.
If smbsubscribe is terminated from outside (e.g. via input of Ctrl+C by the user), the program will attempt to unsubscribe from the broker.
The communication with the broker exclusively takes place using UDP.

### smbsmbpublish

smbpublish is called with the pattern `smbpublish broker topic message`, where `broker` is the host name or IP-address of the broker, `topic` is the topic to publish under and `message` is the message to publish.
The destination port on the broker that requests will be sent to is 8080, based on a constant in [smbconstants.h](smbconstants.h).
The publisher will send a request to the broker to have a message forwarded under the specified topic.
After sending the request to the broker, the publisher terminates.
The communication with the broker exclusively takes place using UDP.

### smbpublishperiodic

smbpublishperiodic basically functions in the same way as smbpublish, with the following exceptions:

* the program call pattern does not include the `message` argument, as the messages will be automatically generated by the program
* the program does not terminate after sending a single request to the broker, but will instead periodically send a message to the broker every 5 seconds in an infinite loop, under the specified topic
* the generated messages each contain the current Unix time

### smbbroker

smbbroker is called without arguments.
The broker will await requests on port 8080 (based on a constant in [smbconstants.h](smbconstants.h)) in an infinite loop.
Through these requests, clients can use the publish, subscribe and unsubscribe functionalities of the broker.
If a request matches none of these functionalities, it will be discarded.
The broker uses statically allocated memory to memorize subscriber data, as such there is a hard limit for how many subscribers can be memorized at a time.
The broker will write info regarding received requests, sent messages and other results to stderr and a log file.
Entries to the log file will be prepended with the current date and time.

#### Publish

If the received topic and message pass validation, the broker will search for subscribers in its memory that have subscribes to the relevant topic.
The message will then be forwarded to any found subscribers. If no subscribers for the topic are found, the message will simply be discarded.

#### Subscribe

If the received topic passes validation, the broker attempts to store the subscriber's address data for the specified topic.
If the subscriber is already subscribed to that topic, no action will be taken.
If the memory has no more free space to store the subscriber's data, the request will be discarded without memorizing the subscriber.

#### Unsubscribe

If the received topic passes validation, the broker attempts to remove the subscriber's data from the subscriber list of the specified topic.
If the subscriber is not found in that list, no action is taken.
If the subscriber was found and the removal from the list was successful, and the removed subscriber was the last for that topic, the topic will be removed as well, so that space is freed for new topics and subscribers.

### Protocol

The protocol for the communication between subscriber and broker and between publisher and broker is quite simple and does not feature
any mechanisms of message acknowledgement or integrity checks.

The general format that is used for requests is `METHOD!topic[!message]`.
The exclamation mark `!` is used as a separator between the different components of a request.

The following methods are supported:

* `PUB!topic!message`
* `SUB!topic`
* `UNSUB!topic`

Where the following rules apply:

* `topic` and `message` are not allowed to contain the separator character `!`
* `topic` must not contain the wildcard `#`, if it is used as part of a `PUB`-request
* `topic` must not be longer than 20 characters (based on a macro in [smbconstants.h](smbconstants.h))
* `topic` must not be an empty string

Explanation of the request methods:

* `PUB` requests the forwarding of the message `message` under the topic `topic`
* `SUB` requests for the sender to be registered for the topic `topic`, so that it may receive messages to that topic
* `UNSUB` requests for the sender to be unregistered from the topic `topic`, so that no messages to that topic are sent to its address

Messages that a broker sends to a subscriber do not use any special format.
They are simply the unaltered messages that the broker received from a publisher for the subscribed topic.
